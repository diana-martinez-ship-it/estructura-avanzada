#  CONFIGURACIN NGINX - BALANCEADOR DE CARGA ECOMARKET
# Nivel 2: Con algoritmos de balanceo y health checks pasivos

# Eventos de conexi贸n
events {
    worker_connections 1024;
}

http {
    #  Configuraci贸n de logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # 锔 UPSTREAM - Define el grupo de servidores backend
    # Aqu铆 es donde configuramos las m煤ltiples instancias
    upstream ecomarket_backend {
        #  ALGORITMO: least_conn (menos conexiones activas)
        # Alternativa: sin directiva = round_robin (por defecto)
        # Alternativa: ip_hash (sticky sessions por IP)
        least_conn;
        
        #  Instancia 1
        # max_fails: n煤mero de intentos fallidos antes de marcar como down
        # fail_timeout: tiempo que permanece marcado como down (30 segundos)
        server ecomarket-api-1:8000 max_fails=3 fail_timeout=30s;
        
        #  Instancia 2
        server ecomarket-api-2:8000 max_fails=3 fail_timeout=30s;
        
        #  Instancia 3 (descomentada si agregas la tercera instancia)
        # server ecomarket-api-3:8000 max_fails=3 fail_timeout=30s;
        
        #  Keepalive: mantiene conexiones persistentes con backends
        keepalive 32;
    }

    #  SERVIDOR PRINCIPAL - Puerto 80
    server {
        listen 80;
        server_name localhost;

        #  LOCATION / - Todas las peticiones van al backend
        location / {
            #  Proxy pass: env铆a requests al upstream
            proxy_pass http://ecomarket_backend;
            
            #  Headers importantes para el backend
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 憋 Timeouts
            proxy_connect_timeout 5s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            #  Configuraci贸n de conexiones persistentes
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        #  LOCATION /health - Health check endpoint
        # No necesita proxy, solo verifica que nginx est谩 funcionando
        location /nginx-health {
            access_log off;
            return 200 "Nginx Load Balancer is healthy\n";
            add_header Content-Type text/plain;
        }
    }

    #  SERVIDOR DE MTRICAS - Puerto 8080 (opcional)
    server {
        listen 8080;
        server_name localhost;

        #  Stub status - M茅tricas b谩sicas de Nginx
        location /nginx_status {
            stub_status on;
            access_log off;
            # En producci贸n, restringe el acceso:
            # allow 127.0.0.1;
            # deny all;
        }
    }
}
